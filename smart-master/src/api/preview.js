import axios from 'axios';

const API_KEY = 'sk-4c93e30ce1af467eb28d8efd7f44e225';
const API_URL = 'https://api.deepseek.com/v1/chat/completions';

// 预习题生成的提示词模板
const PREVIEW_PROMPT = `作为一名教育专家，请根据以下主题生成一份预习材料，包括推荐视频和预习思考题：

主题：{topic}
要求：1.字数1500字左右 
     2.内容格式严格按照如下案例
     3.如果用户输入的与无监督聚类相关话题，你可以直接返回这个案例一个字都不差，但需要整理一下格式，清晰的展示所有内容
请按照以下案例生成预习内容：

预习部分
本节课要求学生课前完成一定的预习，以便上课时更容易跟上进度。预习内容包括观看Bilibili平台的相关短视频（总时长不超过30分钟），并完成几道思考题。
推荐预习视频资源（Bilibili）
视频1：“〖五分钟机器学习〗物以类聚的Kmeans”（时长约5分钟）。该视频用通俗易懂的方式解释了聚类的含义，并以K-Means为例说明“物以类聚”的道理，适合初学者快速入门。
视频2：“k-means聚类算法 清晰解释（带算例）”（时长约15分钟）。该视频详细讲解了K-Means算法的步骤，并手把手演示了一个聚类计算的例子，有助于理解算法具体过程。
· 
（以上视频资源合计约20分钟，请同学们合理安排时间观看。如有兴趣，可自行在Bilibili搜索更多聚类教学视频，但预习重点以上述内容为主。）
预习思考题
观看上述视频后，请完成以下思考题。每道题目后附有参考答案，供同学自检。
视频1中讲到的“物以类聚，人以群分”这句话说明了聚类的什么含义？你如何用自己的话描述聚类概念？
 答案：这句话形象地说明了聚类的核心含义——相似的事物归为一类。用自己的话来说，聚类就是在没有提前分类标识的情况下，把相互类似的样本找出来归成一组。也就是说，同一簇内的对象彼此很相似，不同簇的对象差异很大。聚类分析通过计算数据之间的相似程度，自动将数据划分成几组（簇）。
根据视频内容，总结K-Means聚类算法的一般步骤。
 答案：K-Means算法的基本步骤包括：首先随机选择K个初始聚类中心；然后重复以下过程直至收敛：
分配(step 1)：将每个数据点分配给最近的聚类中心（通常根据欧氏距离判断最近）。
更新(step 2)：针对每个簇，重新计算该簇中所有数据点的均值，将均值作为新的聚类中心。
 重复上述分配和更新过程，直到中心不再改变或者达到预定的迭代次数，算法即告终止。最终得到K个簇及对应的簇中心。

视频2中的聚类示例给出了8个点和初始簇中心（A1=(2,10)，A4=(5,8)，A7=(1,2)）。请问：
 a) 第一轮迭代后形成了哪三个簇，各簇的新中心是什么？
 b)该算法迭代了多少轮后收敛，最终的三个簇分别包含哪些点？
 答案：（参考视频中的讲解）
 a) 第一轮迭代后形成的簇如下：
簇1中心由A1(2,10)更新而来，第一轮簇1包含的点有：A1(2,10) 和 A8(4,9)（它们距离A1最近）。这两个点的新中心计算为：(2+4)/2, (10+9)/2 = (3, 9.5)。
簇2中心由A4(5,8)更新而来，第一轮簇2包含的点有：A3(8,4)、A4(5,8)、A5(7,5)、A6(6,4)（这些点距离初始中心A4最近）。新中心计算为这些点坐标的平均，即x坐标(8+5+7+6)/4=6.5，y坐标(4+8+5+4)/4=5.25，得到新中心约为 (6.5, 5.25)。
簇3中心由A7(1,2)更新而来，第一轮簇3包含的点有：A2(2,5)、A7(1,2)（它们距离A7最近）。新中心为(2+1)/2, (5+2)/2 = (1.5, 3.5)。
b) 该K-Means过程共迭代了3轮后收敛。最终簇的划分如下（可与视频中的最终结果对照）：
簇1：包含点 A1(2,10)、A4(5,8)、A8(4,9)。簇中心收敛为 (3, 9) 附近。
簇2：包含点 A3(8,4)、A5(7,5)、A6(6,4)。簇中心收敛为 (7, 4.3) 附近。
簇3：包含点 A2(2,5)、A7(1,2)。簇中心收敛为 (1.5, 3.5)。
解析：视频中讲解，经过第二轮迭代后簇划分发生了变化，第三轮时簇分配稳定不再变化，算法在第三轮后收敛。最终结果中，每个簇的具体成员和中心位置如上所述。这个过程展示了K-Means如何逐步调整簇中心并划分数据，使得簇内点更紧密，簇间点更分散。通过该例题，同学们可以验证自己对算法步骤的理解，加深对聚类收敛过程的直观认识。
完成以上预习题后，相信同学们对聚类尤其是K-Means算法已有初步了解。请带着这些认识走进课堂，我们将在课上进一步深入讲解并练习。预习中如有疑问，也请记录下来，课堂上积极提问讨论。期待大家在课堂上的表现！

`;

export const generatePreview = async (topic, difficulty) => {
  try {
    const response = await axios.post(API_URL, {
      model: "deepseek-chat",
      messages: [
        {
          role: "system",
          content: "你是一位经验丰富的教育专家，擅长设计预习材料和思考题。"
        },
        {
          role: "user",
          content: PREVIEW_PROMPT.replace('{topic}', topic).replace('{difficulty}', difficulty)
        }
      ],
      temperature: 0.7,
      max_tokens: 2000,
    }, {
      headers: {
        'Authorization': `Bearer ${API_KEY}`,
        'Content-Type': 'application/json'
      }
    });

    return response.data.choices[0].message.content;
  } catch (error) {
    console.error('生成预习题失败:', error);
    throw error;
  }
}; 